# 1.1
trials = read.csv("clinical_trial.csv", stringsAsFactor = FALSE)
str(trials)
summary(trials)
max(nchar(trials$abstract))

# 1.2
sum(nchar(trials$abstract) == 0)

# 1.3
trials[which.min(nchar(trials$title)), "title"]

# 2.1
library(tm)
corpusTitle = Corpus(VectorSource(trials$title))
corpusAbstract = Corpus(VectorSource(trials$abstract))
corpusTitle = tm_map(corpusTitle, tolower)
corpusAbstract = tm_map(corpusAbstract, tolower)
corpusTitle = tm_map(corpusTitle, PlainTextDocument)
corpusAbstract = tm_map(corpusAbstract, PlainTextDocument)
corpusTitle = tm_map(corpusTitle, removePunctuation)
corpusAbstract = tm_map(corpusAbstract, removePunctuation)
corpusTitle = tm_map(corpusTitle, removeWords, stopwords("english"))
corpusAbstract = tm_map(corpusAbstract, removeWords, stopwords("english"))
corpusTitle = tm_map(corpusTitle, stemDocument)
corpusAbstract = tm_map(corpusAbstract, stemDocument)
dtmTitle = DocumentTermMatrix(corpusTitle)
dtmAbstract = DocumentTermMatrix(corpusAbstract)
sparseTitle = removeSparseTerms(dtmTitle, 0.95)
sparseAbstract = removeSparseTerms(dtmAbstract, 0.95)
dtmTitle = as.data.frame(as.matrix(sparseTitle))
dtmAbstract = as.data.frame(as.matrix(sparseAbstract))
str(dtmTitle)
str(dtmAbstract)

# 2.3
which.max(colSums(dtmAbstract))

# 3.1
colnames(dtmTitle) = paste0("T", colnames(dtmTitle))
colnames(dtmAbstract) = paste0("A", colnames(dtmAbstract))

# 3.2
dtm = cbind(dtmTitle, dtmAbstract)
dtm$trial = trials$trial
ncol(dtm)

# 3.3
library(caTools)
set.seed(144)
spl = sample.split(dtm$trial, SplitRatio=0.7)
train = subset(dtm, spl == TRUE)
test = subset(dtm, spl == FALSE)
table(test$trial)
313 / (313+245)

# 3.4
library(rpart)
library(rpart.plot)
trialCART = rpart(trial ~ ., data=train, method="class")
prp(trialCART)

# 3.5
predTrain = predict(trialCART, data=train)
max(predTrain[,2])

# 3.7
predTrain.prob = predTrain[,2]
table(train$trial, predTrain.prob >= 0.5)
(631+441) / (631+99+131+441) #accuracy
441 / (441+131) #sensitivity
631 / (631+99) #specificity

# 4.1
predTest = predict(trialCART, newdata=test)
predTest.prob = predTest[,2]
table(test$trial, predTest.prob >= 0.5)
(261+162) / (261+52+83+162)

# 4.2
library(ROCR)
predROCR = prediction(predTest.prob, test$trial)
perfROCR = performance(predROCR, "tpr", "fpr")
as.numeric(performance(predROCR, "auc")@y.values)
plot(perfROCR, colorize=TRUE)